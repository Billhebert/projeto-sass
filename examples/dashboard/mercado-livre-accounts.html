<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mercado Livre - Gerenciar Contas</title>
  <link rel="stylesheet" href="../../dist/styles/dashboard.css">
  <style>
    .ml-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .ml-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
    }

    .ml-header h1 {
      font-size: 28px;
      color: #333;
      margin: 0;
    }

    .ml-header-actions {
      display: flex;
      gap: 10px;
    }

    .btn-primary {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background 0.3s;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #333;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.3s;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.3s;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .accounts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .account-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
      transition: box-shadow 0.3s, transform 0.3s;
      cursor: pointer;
    }

    .account-card:hover {
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    .account-card.active {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .account-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
    }

    .account-name {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin: 0;
    }

    .account-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-active {
      background: #dcfce7;
      color: #166534;
    }

    .status-syncing {
      background: #fef3c7;
      color: #92400e;
    }

    .status-error {
      background: #fee2e2;
      color: #991b1b;
    }

    .account-info {
      font-size: 13px;
      color: #666;
      line-height: 1.8;
      margin-bottom: 15px;
    }

    .account-info-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .account-info-label {
      font-weight: 500;
      color: #333;
    }

    .account-info-value {
      color: #666;
      word-break: break-all;
    }

    .account-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .account-actions .btn-danger {
      flex: 1;
    }

    .metrics-section {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .metrics-section h2 {
      font-size: 20px;
      color: #333;
      margin: 0 0 20px 0;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }

    .metric-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .metric-card.alt1 {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .metric-card.alt2 {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .metric-card.alt3 {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

    .metric-label {
      font-size: 12px;
      opacity: 0.9;
      margin-bottom: 10px;
    }

    .metric-value {
      font-size: 28px;
      font-weight: 700;
    }

    .no-accounts {
      text-align: center;
      padding: 60px 20px;
      background: white;
      border-radius: 8px;
      border: 2px dashed #e5e7eb;
    }

    .no-accounts-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .no-accounts-text {
      font-size: 18px;
      color: #666;
      margin-bottom: 30px;
    }

    .sync-status {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      color: #666;
      margin-top: 10px;
    }

    .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid #e5e7eb;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading {
      display: flex;
      justify-content: center;
      padding: 40px;
    }

    .success-message {
      background: #dcfce7;
      border: 1px solid #86efac;
      color: #166534;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .ml-header {
        flex-direction: column;
        gap: 15px;
      }

      .accounts-grid {
        grid-template-columns: 1fr;
      }

      .metrics-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="ml-container">
    <!-- Header -->
    <div class="ml-header">
      <h1>üí∞ Mercado Livre - Gerenciar Contas</h1>
      <div class="ml-header-actions">
        <button class="btn-primary" id="addAccountBtn">+ Conectar Conta</button>
        <button class="btn-secondary" id="syncBtn">‚Üª Sincronizar Agora</button>
      </div>
    </div>

    <!-- Success Message -->
    <div id="successMessage" class="success-message" style="display: none;"></div>

    <!-- Accounts Section -->
    <div id="accountsSection">
      <h2 style="margin-bottom: 20px;">Suas Contas Conectadas</h2>
      <div id="accountsList" class="accounts-grid"></div>
    </div>

    <!-- Metrics Section -->
    <div id="metricsSection" class="metrics-section" style="display: none;">
      <h2>üìä M√©tricas Consolidadas</h2>
      <div class="metrics-grid" id="metricsGrid"></div>
    </div>

    <!-- Details Section -->
    <div id="detailsSection" style="display: none;">
      <h2 style="margin-bottom: 20px;">Detalhes da Conta</h2>
      <div id="detailsContent"></div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="../../src/scripts/mercado-livre/secure-storage.js"></script>
  <script src="../../src/scripts/mercado-livre/auth.js"></script>
  <script src="../../src/scripts/mercado-livre/api-client.js"></script>
  <script src="../../src/scripts/mercado-livre/sync-manager.js"></script>

  <script>
    class MLAccountsPanel {
      constructor() {
        this.storage = new SecureTokenStorage();
        this.auth = new MercadoLivreAuth();
        this.syncManager = null;
        this.init();
      }

      async init() {
        try {
          // Inicializar sincronizador
          this.syncManager = new MLSyncManager();
          await this.syncManager.initialize();

          // Setup event listeners
          document.getElementById('addAccountBtn').addEventListener('click', 
            () => this.connectNewAccount());
          document.getElementById('syncBtn').addEventListener('click', 
            () => this.syncNow());

          // Exibir contas
          await this.displayAccounts();

          // Exibir m√©tricas
          this.displayMetrics();

          // Verificar sucesso na URL
          this.checkSuccessMessage();

          // Auto-sync a cada 5 minutos
          this.syncManager.enableAutoSync(5);

        } catch (error) {
          console.error('Erro ao inicializar painel:', error);
        }
      }

      async displayAccounts() {
        const accounts = this.storage.getAllAccounts();
        const container = document.getElementById('accountsList');

        if (accounts.length === 0) {
          container.innerHTML = `
            <div style="grid-column: 1 / -1;">
              <div class="no-accounts">
                <div class="no-accounts-icon">üì±</div>
                <div class="no-accounts-text">Nenhuma conta conectada</div>
                <p>Clique em "Conectar Conta" para adicionar sua primeira conta do Mercado Livre</p>
              </div>
            </div>
          `;
          document.getElementById('metricsSection').style.display = 'none';
          return;
        }

        container.innerHTML = accounts.map(acc => {
          const status = this.syncManager.getSyncStatus(acc.id);
          const statusClass = status.status === 'error' ? 'status-error' : 
                            status.status === 'syncing' ? 'status-syncing' : 'status-active';
          
          return `
            <div class="account-card ${acc.active ? 'active' : ''}">
              <div class="account-header">
                <h3 class="account-name">${acc.nickname}</h3>
                <span class="account-status ${statusClass}">
                  ${status.status === 'syncing' ? '‚ü≥' : '‚óè'} 
                  ${status.status === 'syncing' ? 'Sincronizando' :
                    status.status === 'success' ? 'Conectada' : 'Erro'}
                </span>
              </div>

              <div class="account-info">
                <div class="account-info-item">
                  <span class="account-info-label">ID:</span>
                  <span class="account-info-value">${acc.id}</span>
                </div>
                <div class="account-info-item">
                  <span class="account-info-label">Email:</span>
                  <span class="account-info-value">${acc.email || '-'}</span>
                </div>
                <div class="account-info-item">
                  <span class="account-info-label">Conectada:</span>
                  <span class="account-info-value">${this.formatDate(acc.created_at)}</span>
                </div>
                <div class="account-info-item">
                  <span class="account-info-label">Progresso:</span>
                  <span class="account-info-value">${status.progress || 0}%</span>
                </div>
              </div>

              ${status.lastSync ? `
                <div class="sync-status">
                  <span>‚úì √öltima sincroniza√ß√£o: ${this.formatTime(status.lastSync)}</span>
                </div>
              ` : ''}

              <div class="account-actions">
                <button class="btn-danger" onclick="panel.disconnectAccount(${acc.id})">
                  Desconectar
                </button>
              </div>
            </div>
          `;
        }).join('');

        document.getElementById('metricsSection').style.display = 'block';
      }

      displayMetrics() {
        if (!this.syncManager) return;

        const metrics = this.syncManager.getAggregatedMetrics();
        const metricsGrid = document.getElementById('metricsGrid');

        metricsGrid.innerHTML = `
          <div class="metric-card">
            <div class="metric-label">üì¶ Produtos Totais</div>
            <div class="metric-value">${metrics.totalProducts}</div>
          </div>
          <div class="metric-card alt1">
            <div class="metric-label">üõçÔ∏è Vendas (30d)</div>
            <div class="metric-value">${metrics.totalSales}</div>
          </div>
          <div class="metric-card alt2">
            <div class="metric-label">üí∞ Faturamento</div>
            <div class="metric-value">R$ ${metrics.totalRevenue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
          </div>
          <div class="metric-card alt3">
            <div class="metric-label">üìä Ticket M√©dio</div>
            <div class="metric-value">R$ ${metrics.averageOrderValue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
          </div>
        `;
      }

      async connectNewAccount() {
        this.auth.connectAccount();
      }

      async syncNow() {
        try {
          const btn = document.getElementById('syncBtn');
          btn.disabled = true;
          btn.textContent = '‚ü≥ Sincronizando...';

          await this.syncManager.syncAllAccounts();

          btn.textContent = '‚úì Sincronizado!';
          setTimeout(() => {
            btn.disabled = false;
            btn.textContent = '‚Üª Sincronizar Agora';
          }, 2000);

          // Atualizar displays
          await this.displayAccounts();
          this.displayMetrics();

        } catch (error) {
          console.error('Erro ao sincronizar:', error);
          alert('Erro na sincroniza√ß√£o: ' + error.message);
        }
      }

      async disconnectAccount(userId) {
        if (!confirm('Tem certeza que deseja desconectar esta conta?')) {
          return;
        }

        try {
          await this.syncManager.disconnectAccount(userId);
          await this.displayAccounts();
          this.displayMetrics();
        } catch (error) {
          console.error('Erro ao desconectar:', error);
          alert('Erro: ' + error.message);
        }
      }

      checkSuccessMessage() {
        const params = new URLSearchParams(window.location.search);
        if (params.get('success') === 'true') {
          const account = params.get('account');
          const msg = document.getElementById('successMessage');
          msg.textContent = `‚úì Conta ${account} conectada com sucesso!`;
          msg.style.display = 'block';

          // Limpar URL
          window.history.replaceState({}, document.title, window.location.pathname);

          // Atualizar em 2 segundos
          setTimeout(() => this.displayAccounts(), 2000);
        }
      }

      formatDate(dateString) {
        return new Date(dateString).toLocaleDateString('pt-BR');
      }

      formatTime(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;

        if (diff < 60000) return 'agora mesmo';
        if (diff < 3600000) return `h√° ${Math.floor(diff / 60000)} minutos`;
        if (diff < 86400000) return `h√° ${Math.floor(diff / 3600000)} horas`;
        return date.toLocaleDateString('pt-BR');
      }
    }

    // Inicializar painel
    let panel;
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        panel = new MLAccountsPanel();
      });
    } else {
      panel = new MLAccountsPanel();
    }
  </script>
</body>
</html>
