# docker-compose.production.yml
# Production environment com Load Balancer, SSL Let's Encrypt, e backup automático

version: "3.8"

services:
  # ================================================================
  # REVERSE PROXY / LOAD BALANCER COM CERTBOT
  # ================================================================
  nginx:
    image: nginx:latest
    container_name: vendata-nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.production.conf:/etc/nginx/nginx.conf:ro
      - ./certs/letsencrypt:/etc/letsencrypt:ro
      - ./certs/renewal:/etc/letsencrypt-renewal:ro
      - ./data/nginx-logs:/var/log/nginx
    depends_on:
      - api-1
      - api-2
      - api-3
      - mongo-express
    networks:
      - vendata-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3011/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    environment:
      - TZ=America/Sao_Paulo
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  # ================================================================
  # CERTBOT - AUTOMAÇÃO DE CERTIFICADO SSL
  # ================================================================
  certbot:
    image: certbot/certbot:latest
    container_name: vendata-certbot
    restart: always
    volumes:
      - ./certs/letsencrypt:/etc/letsencrypt
      - ./certs/renewal:/etc/letsencrypt-renewal
      - ./certbot-entrypoint.sh:/docker-entrypoint-sh-wrapper:ro
    entrypoint: /bin/sh -c
    command:
      - |
        certbot renew --quiet --webroot --webroot-path=/var/www/certbot
        sleep 86400
    networks:
      - vendata-network
    depends_on:
      - nginx
    environment:
      - TZ=America/Sao_Paulo

  # ================================================================
  # API INSTANCES - 3 instâncias com load balancing
  # ================================================================
  api-1:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: vendata-api-1
    restart: always
    env_file: .env.production
    environment:
      - PORT=3011
      - INSTANCE_ID=1
      - NODE_ENV=production
    depends_on:
      - mongo
      - redis
    networks:
      - vendata-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3011/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  api-2:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: vendata-api-2
    restart: always
    env_file: .env.production
    environment:
      - PORT=3011
      - INSTANCE_ID=2
      - NODE_ENV=production
    depends_on:
      - mongo
      - redis
    networks:
      - vendata-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3011/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  api-3:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: vendata-api-3
    restart: always
    env_file: .env.production
    environment:
      - PORT=3011
      - INSTANCE_ID=3
      - NODE_ENV=production
    depends_on:
      - mongo
      - redis
    networks:
      - vendata-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3011/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ================================================================
  # FRONTEND - React SPA
  # ================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: vendata-frontend
    restart: always
    environment:
      - VITE_API_URL=https://api.vendata.com.br
      - NODE_ENV=production
    networks:
      - vendata-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5173"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ================================================================
  # MONGODB - Banco de dados com persistência
  # ================================================================
  mongo:
    image: mongo:7
    container_name: vendata-mongo
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
      TZ: America/Sao_Paulo
    volumes:
      - mongo-data:/data/db
      - mongo-config:/data/configdb
      - ./backup:/backup
    networks:
      - vendata-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh --authenticationDatabase admin -u ${MONGO_USER} -p ${MONGO_PASSWORD}
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ================================================================
  # REDIS - Cache e sessões
  # ================================================================
  redis:
    image: redis:7-alpine
    container_name: vendata-redis
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes --appendfsync everysec
    volumes:
      - redis-data:/data
    networks:
      - vendata-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ================================================================
  # BACKUP AUTOMÁTICO
  # ================================================================
  backup:
    image: mongo:7
    container_name: vendata-backup
    restart: always
    env_file: .env.production
    volumes:
      - ./backup:/backup
      - ./backup-mongodb.sh:/backup.sh:ro
    entrypoint: /bin/bash -c "while true; do bash /backup.sh; sleep 86400; done"
    depends_on:
      - mongo
    networks:
      - vendata-network
    environment:
      - TZ=America/Sao_Paulo
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

  # ================================================================
  # MONGO EXPRESS - Interface Web para MongoDB
  # ================================================================
  mongo-express:
    image: mongo-express:1.0.2
    container_name: vendata-mongo-express
    restart: always
    ports:
      - "8081:8081"
    depends_on:
      - mongo
    networks:
      - vendata-network
    environment:
      - ME_CONFIG_MONGODB_URL=mongodb://mongo:27017
      - ME_CONFIG_MONGODB_ADMINUSERNAME=meAdmin
      - ME_CONFIG_MONGODB_ADMINPASSWORD=SecureMongo2024Vendata
      - ME_CONFIG_BASICAUTH_USERNAME=admin
      - ME_CONFIG_BASICAUTH_PASSWORD=SecureAdminToken2024Vendata
      - ME_CONFIG_MONGODB_SERVER=mongo
      - ME_CONFIG_OPTIONS_THEME=bootstrap4
      - TZ=America/Sao_Paulo
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

volumes:
  mongo-data:
    driver: local
  mongo-config:
    driver: local
  redis-data:
    driver: local

networks:
  vendata-network:
    driver: bridge
