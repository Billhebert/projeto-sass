version: "3.8"

services:
  # ========================================
  # MONGODB - Banco de Dados Principal
  # ========================================
  mongodb:
    image: mongo:7.0
    container_name: vendata-mongodb-prod
    restart: always
    ports:
      - "127.0.0.1:27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD}
      MONGO_INITDB_DATABASE: vendata_prod
    volumes:
      - mongodb_data_prod:/data/db
      - mongodb_config_prod:/data/configdb
    networks:
      - vendata-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ========================================
  # REDIS - Cache e Sessions
  # ========================================
  redis:
    image: redis:7-alpine
    container_name: vendata-redis-prod
    restart: always
    ports:
      - "127.0.0.1:6379:6379"
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    volumes:
      - redis_data_prod:/data
    networks:
      - vendata-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ========================================
  # API BACKEND
  # ========================================
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: vendata-api-prod
    restart: always
    ports:
      - "127.0.0.1:3011:3011"
    environment:
      NODE_ENV: production
      APP_PORT: 3011
      MONGODB_URI: mongodb://${MONGODB_USER}:${MONGODB_PASSWORD}@mongodb:27017/vendata_prod?authSource=admin
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379/0
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRE_IN: ${JWT_EXPIRE_IN}
      REFRESH_TOKEN_SECRET: ${REFRESH_TOKEN_SECRET}
      REFRESH_TOKEN_EXPIRE_IN: ${REFRESH_TOKEN_EXPIRE_IN}
      API_URL: ${API_URL}
      FRONTEND_URL: ${FRONTEND_URL}
      EMAIL_MODE: ${EMAIL_MODE}
      EMAIL_FROM: ${EMAIL_FROM}
      EMAIL_FROM_NAME: ${EMAIL_FROM_NAME}
      LOG_LEVEL: ${LOG_LEVEL}
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS}
      RATE_LIMIT_MAX_REQUESTS: ${RATE_LIMIT_MAX_REQUESTS}
      CORS_ORIGIN: ${CORS_ORIGIN}
      MERCADO_LIVRE_CLIENT_ID: ${MERCADO_LIVRE_CLIENT_ID}
      MERCADO_LIVRE_CLIENT_SECRET: ${MERCADO_LIVRE_CLIENT_SECRET}
      MERCADO_LIVRE_REDIRECT_URI: ${MERCADO_LIVRE_REDIRECT_URI}
      MERCADO_PAGO_ACCESS_TOKEN: ${MERCADO_PAGO_ACCESS_TOKEN}
      TZ: ${TZ}
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - vendata-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3011/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./backend/logs:/app/logs
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ========================================
  # FRONTEND
  # ========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${API_URL}
        VITE_APP_URL: ${FRONTEND_URL}
    container_name: vendata-frontend-prod
    restart: always
    ports:
      - "127.0.0.1:5173:5173"
    environment:
      NODE_ENV: production
      VITE_API_URL: ${API_URL}
      VITE_APP_URL: ${FRONTEND_URL}
    depends_on:
      - api
    networks:
      - vendata-network
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:5173/",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

  # ========================================
  # NGINX - Reverse Proxy + SSL
  # ========================================
  nginx:
    image: nginx:alpine
    container_name: vendata-nginx-prod
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.prod.conf:/etc/nginx/nginx.conf:ro
      - ./ssl/vendata.com.br.crt:/etc/nginx/ssl/vendata.com.br.crt:ro
      - ./ssl/vendata.com.br.key:/etc/nginx/ssl/vendata.com.br.key:ro
      - nginx_cache_prod:/var/cache/nginx
      - ./nginx/logs:/var/log/nginx
    depends_on:
      - api
      - frontend
    networks:
      - vendata-network
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

# ========================================
# VOLUMES
# ========================================
volumes:
  mongodb_data_prod:
    driver: local
  mongodb_config_prod:
    driver: local
  redis_data_prod:
    driver: local
  nginx_cache_prod:
    driver: local

# ========================================
# NETWORKS
# ========================================
networks:
  vendata-network:
    driver: bridge
