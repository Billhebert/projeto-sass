version: "3.8"

# Docker Compose backup service for MongoDB
# This service runs scheduled backups of MongoDB

services:
  mongo-backup:
    image: mongo:7
    container_name: projeto-sass-mongo-backup
    restart: unless-stopped
    
    # Environment variables for backup configuration
    environment:
      # Backup schedule (cron format)
      # Default: Every day at 2:00 AM
      BACKUP_SCHEDULE: "0 2 * * *"
      
      # MongoDB connection
      MONGODB_URI: mongodb://admin:changeme@mongo:27017/projeto-sass?authSource=admin
      
      # Backup retention (days)
      BACKUP_RETENTION_DAYS: 30
      
      # Cloud backup (optional)
      # AWS_S3_BUCKET: your-backup-bucket
      # AWS_REGION: us-east-1
      # GCS_BUCKET: your-gcs-bucket
    
    # Volumes for backup storage
    volumes:
      # Local backup directory (persist on host)
      - ./backups:/backups
      
      # Backup script
      - ./backup-mongodb.sh:/scripts/backup-mongodb.sh
      - ./docker-entrypoint-backup.sh:/docker-entrypoint-backup.sh
    
    # Use entrypoint script to schedule backups
    entrypoint: /docker-entrypoint-backup.sh
    
    # Only start if needed
    # Uncomment to enable automatic backups
    # profiles: [backup]
    
    depends_on:
      mongo:
        condition: service_healthy
    
    networks:
      - internal

# Reference to existing volumes and networks from main compose file
volumes:
  backups:

networks:
  internal:
    driver: bridge
